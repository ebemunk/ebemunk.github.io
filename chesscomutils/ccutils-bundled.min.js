"use strict";function similar_text(e,n,t){if(null===e||null===n||"undefined"==typeof e||"undefined"==typeof n)return 0;e+="",n+="";var r,o,i,a,c=0,u=0,f=0,s=e.length,l=n.length;for(f=0,r=0;s>r;r++)for(o=0;l>o;o++){for(i=0;s>r+i&&l>o+i&&e.charAt(r+i)===n.charAt(o+i);i++);i>f&&(f=i,c=r,u=o)}return a=f,a&&(c&&u&&(a+=similar_text(e.substr(0,c),n.substr(0,u))),s>c+f&&l>u+f&&(a+=similar_text(e.substr(c+f,s-c-f),n.substr(u+f,l-u-f)))),t?200*a/(s+l):a}var Chess=function(e){function n(){un=new Array(128),fn={w:U,b:U},sn=M,ln={w:0,b:0},pn=U,dn=0,vn=1,hn=[],gn={},c(i())}function t(){r(H)}function r(e){var t=e.split(/\s+/),r=t[0],a=0;if(!o(e).valid)return!1;n();for(var u=0;u<r.length;u++){var s=r.charAt(u);if("/"===s)a+=8;else if(O(s))a+=parseInt(s,10);else{var l="a">s?M:D;f({type:s.toLowerCase(),color:l},I(a)),a++}}return sn=t[1],t[2].indexOf("K")>-1&&(ln.w|=en.KSIDE_CASTLE),t[2].indexOf("Q")>-1&&(ln.w|=en.QSIDE_CASTLE),t[2].indexOf("k")>-1&&(ln.b|=en.KSIDE_CASTLE),t[2].indexOf("q")>-1&&(ln.b|=en.QSIDE_CASTLE),pn="-"===t[3]?U:an[t[3]],dn=parseInt(t[4],10),vn=parseInt(t[5],10),c(i()),!0}function o(e){var n={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) is invalid.",5:"3rd field (castling availability) is invalid.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 8 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large]."},t=e.split(/\s+/);if(6!==t.length)return{valid:!1,error_number:1,error:n[1]};if(isNaN(t[5])||parseInt(t[5],10)<=0)return{valid:!1,error_number:2,error:n[2]};if(isNaN(t[4])||parseInt(t[4],10)<0)return{valid:!1,error_number:3,error:n[3]};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{valid:!1,error_number:4,error:n[4]};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(t[2]))return{valid:!1,error_number:5,error:n[5]};if(!/^(w|b)$/.test(t[1]))return{valid:!1,error_number:6,error:n[6]};var r=t[0].split("/");if(8!==r.length)return{valid:!1,error_number:7,error:n[7]};for(var o=0;o<r.length;o++){for(var i=0,a=!1,c=0;c<r[o].length;c++)if(isNaN(r[o][c])){if(!/^[prnbqkPRNBQK]$/.test(r[o][c]))return{valid:!1,error_number:9,error:n[9]};i+=1,a=!1}else{if(a)return{valid:!1,error_number:8,error:n[8]};i+=parseInt(r[o][c],10),a=!0}if(8!==i)return{valid:!1,error_number:10,error:n[10]}}return{valid:!0,error_number:0,error:n[0]}}function i(){for(var e=0,n="",t=an.a8;t<=an.h1;t++){if(null==un[t])e++;else{e>0&&(n+=e,e=0);var r=un[t].color,o=un[t].type;n+=r===M?o.toUpperCase():o.toLowerCase()}t+1&136&&(e>0&&(n+=e),t!==an.h1&&(n+="/"),e=0,t+=8)}var i="";ln[M]&en.KSIDE_CASTLE&&(i+="K"),ln[M]&en.QSIDE_CASTLE&&(i+="Q"),ln[D]&en.KSIDE_CASTLE&&(i+="k"),ln[D]&en.QSIDE_CASTLE&&(i+="q"),i=i||"-";var a=pn===U?"-":I(pn);return[n,sn,i,a,dn,vn].join(" ")}function a(e){for(var n=0;n<e.length;n+=2)"string"==typeof e[n]&&"string"==typeof e[n+1]&&(gn[e[n]]=e[n+1]);return gn}function c(e){hn.length>0||(e!==H?(gn.SetUp=e,gn.FEN="1"):(delete gn.SetUp,delete gn.FEN))}function u(e){var n=un[an[e]];return n?{type:n.type,color:n.color}:null}function f(e,n){if(!("type"in e&&"color"in e))return!1;if(-1===z.indexOf(e.type.toLowerCase()))return!1;if(!(n in an))return!1;var t=an[n];return un[t]={type:e.type,color:e.color},e.type===G&&(fn[e.color]=t),c(i()),!0}function s(e){var n=u(e);return un[an[e]]=null,n&&n.type===G&&(fn[n.color]=U),c(i()),n}function l(e,n,t,r,o){var i={color:sn,from:n,to:t,flags:r,piece:e[n].type};return o&&(i.flags|=en.PROMOTION,i.promotion=o),e[t]?i.captured=e[t].type:r&en.EP_CAPTURE&&(i.captured=$),i}function p(e){function n(e,n,t,r,o){if(e[t].type!==$||S(r)!==on&&S(r)!==nn)n.push(l(e,t,r,o));else for(var i=[B,j,Q,q],a=0,c=i.length;c>a;a++)n.push(l(e,t,r,o,i[a]))}var t=[],r=sn,o=x(r),i={b:rn,w:tn},a=an.a8,c=an.h1,u=!1,f="undefined"!=typeof e&&"legal"in e?e.legal:!0;if("undefined"!=typeof e&&"square"in e){if(!(e.square in an))return[];a=c=an[e.square],u=!0}for(var s=a;c>=s;s++)if(136&s)s+=7;else{var p=un[s];if(null!=p&&p.color===r)if(p.type===$){var d=s+Y[r][0];if(null==un[d]){n(un,t,s,d,en.NORMAL);var d=s+Y[r][1];i[r]===S(s)&&null==un[d]&&n(un,t,s,d,en.BIG_PAWN)}for(g=2;4>g;g++){var d=s+Y[r][g];136&d||(null!=un[d]&&un[d].color===o?n(un,t,s,d,en.CAPTURE):d===pn&&n(un,t,s,pn,en.EP_CAPTURE))}}else for(var g=0,m=F[p.type].length;m>g;g++)for(var b=F[p.type][g],d=s;;){if(d+=b,136&d)break;if(null!=un[d]){if(un[d].color===r)break;n(un,t,s,d,en.CAPTURE);break}if(n(un,t,s,d,en.NORMAL),"n"===p.type||"k"===p.type)break}}if(!u||c===fn[r]){if(ln[r]&en.KSIDE_CASTLE){var y=fn[r],_=y+2;null!=un[y+1]||null!=un[_]||v(o,fn[r])||v(o,y+1)||v(o,_)||n(un,t,fn[r],_,en.KSIDE_CASTLE)}if(ln[r]&en.QSIDE_CASTLE){var y=fn[r],_=y-2;null!=un[y-1]||null!=un[y-2]||null!=un[y-3]||v(o,fn[r])||v(o,y-1)||v(o,_)||n(un,t,fn[r],_,en.QSIDE_CASTLE)}}if(!f)return t;for(var C=[],s=0,m=t.length;m>s;s++)A(t[s]),h(r)||C.push(t[s]),w();return C}function d(e){var n="";if(e.flags&en.KSIDE_CASTLE)n="O-O";else if(e.flags&en.QSIDE_CASTLE)n="O-O-O";else{var t=k(e);e.piece!==$&&(n+=e.piece.toUpperCase()+t),e.flags&(en.CAPTURE|en.EP_CAPTURE)&&(e.piece===$&&(n+=I(e.from)[0]),n+="x"),n+=I(e.to),e.flags&en.PROMOTION&&(n+="="+e.promotion.toUpperCase())}return A(e),g()&&(n+=m()?"#":"+"),w(),n}function v(e,n){for(var t=an.a8;t<=an.h1;t++)if(136&t)t+=7;else if(null!=un[t]&&un[t].color===e){var r=un[t],o=t-n,i=o+119;if(W[i]&1<<V[r.type]){if(r.type===$){if(o>0){if(r.color===M)return!0}else if(r.color===D)return!0;continue}if("n"===r.type||"k"===r.type)return!0;for(var a=J[i],c=t+a,u=!1;c!==n;){if(null!=un[c]){u=!0;break}c+=a}if(!u)return!0}}return!1}function h(e){return v(x(e),fn[e])}function g(){return h(sn)}function m(){return g()&&0===p().length}function b(){return!g()&&0===p().length}function y(){for(var e={},n=[],t=0,r=0,o=an.a8;o<=an.h1;o++)if(r=(r+1)%2,136&o)o+=7;else{var i=un[o];i&&(e[i.type]=i.type in e?e[i.type]+1:1,i.type===Q&&n.push(r),t++)}if(2===t)return!0;if(3===t&&(1===e[Q]||1===e[q]))return!0;if(t===e[Q]+2){for(var a=0,c=n.length,o=0;c>o;o++)a+=n[o];if(0===a||a===c)return!0}return!1}function _(){for(var e=[],n={},t=!1;;){var r=w();if(!r)break;e.push(r)}for(;;){var o=i().split(" ").slice(0,4).join(" ");if(n[o]=o in n?n[o]+1:1,n[o]>=3&&(t=!0),!e.length)break;A(e.pop())}return t}function C(){for(var e=[],n={},t=!1;;){var r=w();if(!r)break;e.push(r)}for(;;){var o=i().split(" ").slice(0,4).join(" ");if(n[o]=o in n?n[o]+1:1,n[o]>=2&&(t=!0),!e.length)break;A(e.pop())}return t}function E(e){hn.push({move:e,kings:{b:fn.b,w:fn.w},turn:sn,castling:{b:ln.b,w:ln.w},ep_square:pn,half_moves:dn,move_number:vn})}function A(e){var n=sn,t=x(n);if(E(e),un[e.to]=un[e.from],un[e.from]=null,e.flags&en.EP_CAPTURE&&(sn===D?un[e.to-16]=null:un[e.to+16]=null),e.flags&en.PROMOTION&&(un[e.to]={type:e.promotion,color:n}),un[e.to].type===G){if(fn[un[e.to].color]=e.to,e.flags&en.KSIDE_CASTLE){var r=e.to-1,o=e.to+1;un[r]=un[o],un[o]=null}else if(e.flags&en.QSIDE_CASTLE){var r=e.to+1,o=e.to-2;un[r]=un[o],un[o]=null}ln[n]=""}if(ln[n])for(var i=0,a=cn[n].length;a>i;i++)if(e.from===cn[n][i].square&&ln[n]&cn[n][i].flag){ln[n]^=cn[n][i].flag;break}if(ln[t])for(var i=0,a=cn[t].length;a>i;i++)if(e.to===cn[t][i].square&&ln[t]&cn[t][i].flag){ln[t]^=cn[t][i].flag;break}pn=e.flags&en.BIG_PAWN?"b"===sn?e.to-16:e.to+16:U,e.piece===$?dn=0:e.flags&(en.CAPTURE|en.EP_CAPTURE)?dn=0:dn++,sn===D&&vn++,sn=x(sn)}function w(){var e=hn.pop();if(null==e)return null;var n=e.move;fn=e.kings,sn=e.turn,ln=e.castling,pn=e.ep_square,dn=e.half_moves,vn=e.move_number;var t=sn,r=x(sn);if(un[n.from]=un[n.to],un[n.from].type=n.piece,un[n.to]=null,n.flags&en.CAPTURE)un[n.to]={type:n.captured,color:r};else if(n.flags&en.EP_CAPTURE){var o;o=t===D?n.to-16:n.to+16,un[o]={type:$,color:r}}if(n.flags&(en.KSIDE_CASTLE|en.QSIDE_CASTLE)){var i,a;n.flags&en.KSIDE_CASTLE?(i=n.to+1,a=n.to-1):n.flags&en.QSIDE_CASTLE&&(i=n.to-2,a=n.to+1),un[i]=un[a],un[a]=null}return n}function k(e){for(var n=p(),t=e.from,r=e.to,o=e.piece,i=0,a=0,c=0,u=0,f=n.length;f>u;u++){var s=n[u].from,l=n[u].to,d=n[u].piece;o===d&&t!==s&&r===l&&(i++,S(t)===S(s)&&a++,P(t)===P(s)&&c++)}return i>0?a>0&&c>0?I(t):I(t).charAt(c>0?1:0):""}function T(){for(var e="   +------------------------+\n",n=an.a8;n<=an.h1;n++){if(0===P(n)&&(e+=" "+"87654321"[S(n)]+" |"),null==un[n])e+=" . ";else{var t=un[n].type,r=un[n].color,o=r===M?t.toUpperCase():t.toLowerCase();e+=" "+o+" "}n+1&136&&(e+="|\n",n+=8)}return e+="   +------------------------+\n",e+="     a  b  c  d  e  f  g  h\n"}function S(e){return e>>4}function P(e){return 15&e}function I(e){var n=P(e),t=S(e);return"abcdefgh".substring(n,n+1)+"87654321".substring(t,t+1)}function x(e){return e===M?D:M}function O(e){return-1!=="0123456789".indexOf(e)}function K(e){var n=L(e);n.san=d(n),n.to=I(n.to),n.from=I(n.from);var t="";for(var r in en)en[r]&n.flags&&(t+=Z[r]);return n.flags=t,n}function L(e){var n=e instanceof Array?[]:{};for(var t in e)n[t]="object"==typeof t?L(e[t]):e[t];return n}function N(e){return e.replace(/^\s+|\s+$/g,"")}function R(e){for(var n=p({legal:!1}),t=0,r=sn,o=0,i=n.length;i>o;o++){if(A(n[o]),!h(r))if(e-1>0){var a=R(e-1);t+=a}else t++;w()}return t}var D="b",M="w",U=-1,$="p",q="n",Q="b",j="r",B="q",G="k",z="pnbrqkPNBRQK",H="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",X=["1-0","0-1","1/2-1/2","*"],Y={b:[16,32,17,15],w:[-16,-32,-17,-15]},F={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},W=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],J=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],V={p:0,n:1,b:2,r:3,q:4,k:5},Z={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},en={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},nn=7,tn=6,rn=1,on=0,an={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},cn={w:[{square:an.a1,flag:en.QSIDE_CASTLE},{square:an.h1,flag:en.KSIDE_CASTLE}],b:[{square:an.a8,flag:en.QSIDE_CASTLE},{square:an.h8,flag:en.KSIDE_CASTLE}]},un=new Array(128),fn={w:U,b:U},sn=M,ln={w:0,b:0},pn=U,dn=0,vn=1,hn=[],gn={};return r("undefined"==typeof e?H:e),{WHITE:M,BLACK:D,PAWN:$,KNIGHT:q,BISHOP:Q,ROOK:j,QUEEN:B,KING:G,SQUARES:function(){for(var e=[],n=an.a8;n<=an.h1;n++)136&n?n+=7:e.push(I(n));return e}(),FLAGS:Z,load:function(e){return r(e)},reset:function(){return t()},moves:function(e){for(var n=p(e),t=[],r=0,o=n.length;o>r;r++)t.push("undefined"!=typeof e&&"verbose"in e&&e.verbose?K(n[r]):d(n[r]));return t},in_check:function(){return g()},in_checkmate:function(){return m()},in_stalemate:function(){return b()},in_draw:function(){return dn>=100||b()||y()||_()},insufficient_material:function(){return y()},in_threefold_repetition:function(){return _()},in_twofold_repetition:function(){return C()},game_over:function(){return dn>=100||m()||b()||y()||_()},validate_fen:function(e){return o(e)},fen:function(){return i()},pgn:function(e){var n="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\n",t="object"==typeof e&&"number"==typeof e.max_width?e.max_width:0,r=[],o=!1;for(var i in gn)r.push("["+i+' "'+gn[i]+'"]'+n),o=!0;o&&hn.length&&r.push(n);for(var a=[];hn.length>0;)a.push(w());for(var c=[],u="",f=1;a.length>0;){var s=a.pop();1===f&&"b"===s.color?(u="1. ...",f++):"w"===s.color&&(u.length&&c.push(u),u=f+".",f++),u=u+" "+d(s),A(s)}if(u.length&&c.push(u),"undefined"!=typeof gn.Result&&c.push(gn.Result),0===t)return r.join("")+c.join(" ");for(var l=0,i=0;i<c.length;i++)l+c[i].length>t&&0!==i?(" "===r[r.length-1]&&r.pop(),r.push(n),l=0):0!==i&&(r.push(" "),l++),r.push(c[i]),l+=c[i].length;return r.join("")},load_pgn:function(e,n){function r(e){return e.replace(/\n/g,"\\n").replace(/\r/g,"\\r")}function o(e){var n,t,r,o=en.NORMAL,i=e.match(/^([NBKRQ])?([abcdefgh12345678][12345678]?)?(x)?([abcdefgh][12345678])(=?[NBRQ])?/);if("O-O-O"===e.slice(0,5))t=fn[sn],n=t-2,o=en.QSIDE_CASTLE;else if("O-O"===e.slice(0,3))t=fn[sn],n=t+2,o=en.KSIDE_CASTLE;else if(i&&i[1]){var a=i[1].toLowerCase();i[3]&&(o=en.CAPTURE),n=an[i[4]];for(var c=0,u=F[a].length;u>c;c++)for(var f=F[a][c],s=n;;){if(s+=f,136&s)break;var p=un[s];if(p){p.color===sn&&p.type===a&&(!i[2]||I(s).indexOf(i[2])>=0)&&(t=s);break}if("n"===a||"k"===a)break}}else if(i){if(i[3]){n=an[i[4]];for(var c=2;4>c;c++){var s=n-Y[sn][c];136&s||null!=un[s]&&un[s].color===sn&&I(s)[0]===i[2]&&(t=s)}o=un[n]?en.CAPTURE:en.EP_CAPTURE}else{n=an[e.slice(0,2)];var d=n-Y[sn][0],p=un[d];p&&p.type===$&&p.color===sn?t=d:(d=n-Y[sn][1],p=un[d],p&&p.type===$&&p.color===sn&&(t=d,o=en.BIG_PAWN))}i[5]&&(r="undefined"==typeof i[5][1]?i[5][0].toLowerCase():i[5][1].toLowerCase())}return t>=0&&n>=0&&o?l(un,t,n,o,r):void(e.length>0)}function i(e){return o(N(e))}function c(e){var n=!1;for(var t in e)n=!0;return n}function u(e,n){for(var t="object"==typeof n&&"string"==typeof n.newline_char?n.newline_char:"\r?\n",r={},o=e.split(t),i="",a="",c=0;c<o.length;c++)i=o[c].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),a=o[c].replace(/^\[[A-Za-z]+\s"(.*)"\]$/,"$1"),N(i).length>0&&(r[i]=a);return r}var f="object"==typeof n&&"string"==typeof n.newline_char?n.newline_char:"\r?\n",s=new RegExp("^(\\[(.|"+r(f)+")*\\])("+r(f)+")*1.("+r(f)+"|.)*$","g"),p=e.replace(s,"$1");"["!==p[0]&&(p=""),t();var d=u(p,n);for(var v in d)a([v,d[v]]);var h=e.replace(p,"").replace(new RegExp(r(f),"g")," ");h=h.replace(/(\{[^}]+\})+?/g,""),h=h.replace(/\d+\./g,"");var g=N(h).split(new RegExp(/\s+/));g=g.join(",").replace(/,,+/g,",").split(",");for(var m="",b=0;b<g.length-1;b++){if(m=i(g[b]),null==m)return!1;A(m)}if(m=g[g.length-1],X.indexOf(m)>-1)c(gn)&&"undefined"==typeof gn.Result&&a(["Result",m]);else{if(m=i(m),null==m)return!1;A(m)}return!0},header:function(){return a(arguments)},ascii:function(){return T()},turn:function(){return sn},move:function(e){var n=null,t=p();if("string"==typeof e){for(var r=0,o=t.length;o>r;r++)if(e===d(t[r])){n=t[r];break}}else if("object"==typeof e)for(var r=0,o=t.length;o>r;r++)if(!(e.from!==I(t[r].from)||e.to!==I(t[r].to)||"promotion"in t[r]&&e.promotion!==t[r].promotion)){n=t[r];break}if(!n)return null;var i=K(n);return A(n),i},undo:function(){var e=w();return e?K(e):null},clear:function(){return n()},put:function(e,n){return f(e,n)},get:function(e){return u(e)},remove:function(e){return s(e)},perft:function(e){return R(e)},square_color:function(e){if(e in an){var n=an[e];return(S(n)+P(n))%2===0?"light":"dark"}return null},history:function(e){for(var n=[],t=[],r=("undefined"!=typeof e&&"verbose"in e&&e.verbose);hn.length>0;)n.push(w());for(;n.length>0;){var o=n.pop();t.push(r?K(o):d(o)),A(o)}return t}}};"undefined"!=typeof exports&&(exports.Chess=Chess),function(e,n){function t(n){var t,r=e(n.ownerDocument);return n=e(n),t=n.offset(),{x:t.left+n.outerWidth()/2-r.scrollLeft(),y:t.top+n.outerHeight()/2-r.scrollTop()}}var r=/^key/,o=/^(?:mouse|contextmenu)|click/;e.fn.simulate=function(n,t){return this.each(function(){new e.simulate(this,n,t)})},e.simulate=function(n,t,r){var o=e.camelCase("simulate-"+t);this.target=n,this.options=r,this[o]?this[o]():this.simulateEvent(n,t,r)},e.extend(e.simulate,{keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38},buttonCode:{LEFT:0,MIDDLE:1,RIGHT:2}}),e.extend(e.simulate.prototype,{simulateEvent:function(e,n,t){var r=this.createEvent(n,t);this.dispatchEvent(e,n,r,t)},createEvent:function(e,n){return r.test(e)?this.keyEvent(e,n):o.test(e)?this.mouseEvent(e,n):void 0},mouseEvent:function(t,r){var o,i,a,c;return r=e.extend({bubbles:!0,cancelable:"mousemove"!==t,view:window,detail:0,screenX:0,screenY:0,clientX:1,clientY:1,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,button:0,relatedTarget:n},r),document.createEvent?(o=document.createEvent("MouseEvents"),o.initMouseEvent(t,r.bubbles,r.cancelable,r.view,r.detail,r.screenX,r.screenY,r.clientX,r.clientY,r.ctrlKey,r.altKey,r.shiftKey,r.metaKey,r.button,r.relatedTarget||document.body.parentNode),0===o.pageX&&0===o.pageY&&Object.defineProperty&&(i=o.relatedTarget.ownerDocument||document,a=i.documentElement,c=i.body,Object.defineProperty(o,"pageX",{get:function(){return r.clientX+(a&&a.scrollLeft||c&&c.scrollLeft||0)-(a&&a.clientLeft||c&&c.clientLeft||0)}}),Object.defineProperty(o,"pageY",{get:function(){return r.clientY+(a&&a.scrollTop||c&&c.scrollTop||0)-(a&&a.clientTop||c&&c.clientTop||0)}}))):document.createEventObject&&(o=document.createEventObject(),e.extend(o,r),o.button={0:1,1:4,2:2}[o.button]||o.button),o},keyEvent:function(t,r){var o;if(r=e.extend({bubbles:!0,cancelable:!0,view:window,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:0,charCode:n},r),document.createEvent)try{o=document.createEvent("KeyEvents"),o.initKeyEvent(t,r.bubbles,r.cancelable,r.view,r.ctrlKey,r.altKey,r.shiftKey,r.metaKey,r.keyCode,r.charCode)}catch(i){o=document.createEvent("Events"),o.initEvent(t,r.bubbles,r.cancelable),e.extend(o,{view:r.view,ctrlKey:r.ctrlKey,altKey:r.altKey,shiftKey:r.shiftKey,metaKey:r.metaKey,keyCode:r.keyCode,charCode:r.charCode})}else document.createEventObject&&(o=document.createEventObject(),e.extend(o,r));return(/msie [\w.]+/.exec(navigator.userAgent.toLowerCase())||"[object Opera]"==={}.toString.call(window.opera))&&(o.keyCode=r.charCode>0?r.charCode:r.keyCode,o.charCode=n),o},dispatchEvent:function(e,n,t){e.dispatchEvent?e.dispatchEvent(t):e.fireEvent&&e.fireEvent("on"+n,t)},simulateFocus:function(){function n(){r=!0}var t,r=!1,o=e(this.target);o.bind("focus",n),o[0].focus(),r||(t=e.Event("focusin"),t.preventDefault(),o.trigger(t),o.triggerHandler("focus")),o.unbind("focus",n)},simulateBlur:function(){function n(){r=!0}var t,r=!1,o=e(this.target);o.bind("blur",n),o[0].blur(),setTimeout(function(){o[0].ownerDocument.activeElement===o[0]&&o[0].ownerDocument.body.focus(),r||(t=e.Event("focusout"),t.preventDefault(),o.trigger(t),o.triggerHandler("blur")),o.unbind("blur",n)},1)}}),e.extend(e.simulate.prototype,{simulateDrag:function(){var e=0,n=this.target,r=this.options,o=t(n),i=Math.floor(o.x),a=Math.floor(o.y),c=r.dx||0,u=r.dy||0,f=r.moves||3,s={clientX:i,clientY:a};for(this.simulateEvent(n,"mousedown",s);f>e;e++)i+=c/f,a+=u/f,s={clientX:Math.round(i),clientY:Math.round(a)},this.simulateEvent(document,"mousemove",s);this.simulateEvent(n,"mouseup",s),this.simulateEvent(n,"click",s)}})}(jQuery),function(e,n){function t(e,n,t){return e.addEventListener?void e.addEventListener(n,t,!1):void e.attachEvent("on"+n,t)}function r(e){if("keypress"==e.type){var n=String.fromCharCode(e.which);return e.shiftKey||(n=n.toLowerCase()),n}return E[e.which]?E[e.which]:A[e.which]?A[e.which]:String.fromCharCode(e.which).toLowerCase()}function o(e,n){return e.sort().join(",")===n.sort().join(",")}function i(e){e=e||{};var n,t=!1;for(n in P)e[n]?t=!0:P[n]=0;t||(O=!1)}function a(e,n,t,r,i,a){var c,u,f=[],s=t.type;if(!T[e])return[];for("keyup"==s&&l(e)&&(n=[e]),c=0;c<T[e].length;++c)if(u=T[e][c],(r||!u.seq||P[u.seq]==u.level)&&s==u.action&&("keypress"==s&&!t.metaKey&&!t.ctrlKey||o(n,u.modifiers))){var p=!r&&u.combo==i,d=r&&u.seq==r&&u.level==a;(p||d)&&T[e].splice(c,1),f.push(u)}return f}function c(e){var n=[];return e.shiftKey&&n.push("shift"),e.altKey&&n.push("alt"),e.ctrlKey&&n.push("ctrl"),e.metaKey&&n.push("meta"),n}function u(e,n,t,r){L.stopCallback(n,n.target||n.srcElement,t,r)||e(n,t)===!1&&(n.preventDefault&&n.preventDefault(),n.stopPropagation&&n.stopPropagation(),n.returnValue=!1,n.cancelBubble=!0)}function f(e,n,t){var r,o=a(e,n,t),c={},f=0,s=!1;for(r=0;r<o.length;++r)o[r].seq&&(f=Math.max(f,o[r].level));for(r=0;r<o.length;++r)if(o[r].seq){if(o[r].level!=f)continue;s=!0,c[o[r].seq]=1,u(o[r].callback,t,o[r].combo,o[r].seq)}else s||u(o[r].callback,t,o[r].combo);var p="keypress"==t.type&&x;t.type!=O||l(e)||p||i(c),x=s&&"keydown"==t.type}function s(e){"number"!=typeof e.which&&(e.which=e.keyCode);var n=r(e);if(n)return"keyup"==e.type&&I===n?void(I=!1):void L.handleKey(n,c(e),e)}function l(e){return"shift"==e||"ctrl"==e||"alt"==e||"meta"==e}function p(){clearTimeout(C),C=setTimeout(i,1e3)}function d(){if(!_){_={};for(var e in E)e>95&&112>e||E.hasOwnProperty(e)&&(_[E[e]]=e)}return _}function v(e,n,t){return t||(t=d()[e]?"keydown":"keypress"),"keypress"==t&&n.length&&(t="keydown"),t}function h(e,n,t,o){function a(n){return function(){O=n,++P[e],p()}}function c(n){u(t,n,e),"keyup"!==o&&(I=r(n)),setTimeout(i,10)}P[e]=0;for(var f=0;f<n.length;++f){var s=f+1===n.length,l=s?c:a(o||m(n[f+1]).action);b(n[f],l,o,e,f)}}function g(e){return"+"===e?["+"]:e.split("+")}function m(e,n){var t,r,o,i=[];for(t=g(e),o=0;o<t.length;++o)r=t[o],k[r]&&(r=k[r]),n&&"keypress"!=n&&w[r]&&(r=w[r],i.push("shift")),l(r)&&i.push(r);return n=v(r,i,n),{key:r,modifiers:i,action:n}}function b(e,n,t,r,o){S[e+":"+t]=n,e=e.replace(/\s+/g," ");var i,c=e.split(" ");return c.length>1?void h(e,c,n,t):(i=m(e,t),T[i.key]=T[i.key]||[],a(i.key,i.modifiers,{type:i.action},r,e,o),void T[i.key][r?"unshift":"push"]({callback:n,modifiers:i.modifiers,action:i.action,seq:r,level:o,combo:e}))}function y(e,n,t){for(var r=0;r<e.length;++r)b(e[r],n,t)}for(var _,C,E={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},A={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},w={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},k={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},T={},S={},P={},I=!1,x=!1,O=!1,K=1;20>K;++K)E[111+K]="f"+K;for(K=0;9>=K;++K)E[K+96]=K;t(n,"keypress",s),t(n,"keydown",s),t(n,"keyup",s);var L={bind:function(e,n,t){return e=e instanceof Array?e:[e],y(e,n,t),this},unbind:function(e,n){return L.bind(e,function(){},n)},trigger:function(e,n){return S[e+":"+n]&&S[e+":"+n]({},e),this},reset:function(){return T={},S={},this},stopCallback:function(e,n){return(" "+n.className+" ").indexOf(" mousetrap ")>-1?!1:"INPUT"==n.tagName||"SELECT"==n.tagName||"TEXTAREA"==n.tagName||n.isContentEditable},handleKey:f};e.Mousetrap=L,"function"==typeof define&&define.amd&&define(L)}(window,document),function(){$.extend(CC,{classify_opening:function(e){var n,t,r=new Chess,o="";return $.each(e,function(e,i){0===e?o+="1.":e%2===0&&(o+=e/2+1+"."),o+=i+" ",r.move(i);var a=CC.openings[o.trim()];a&&(n=a);var c=CC.openings[CC.openings_fen[r.fen()]];c&&(t=c)}),{moves:n,fen:t}},get_opening:function(e){var n=$('div[id^="notation_"]:visible');if(!n.length)return $("#ccutils_opening_moves").text("Notation window not visible."),void $("#ccutils_opening_fen").text("");if(n.length>1)return $("#ccutils_opening_moves").text("Cannot run when games popped-out."),void $("#ccutils_opening_fen").text(":(");var t=window.location.hash.replace(/#(g|a)=/,"");if(CC.analyzed_games_cache[t]&&CC.analyzed_games_cache[t].count>4&&"N/A"!=CC.analyzed_games_cache[t].opening&&CC.analyzed_games_cache[t].num_moves>16&&!e)return $("#ccutils_opening_moves").text(CC.analyzed_games_cache[t].opening),void $("#ccutils_opening_fen").text(CC.analyzed_games_cache[t].fen);var r,o=[];r=n.find(".notationVertical"),r.length?r.each(function(e,n){$(n).find(".gotomove").each(function(e,n){o.push($(n).text())})}):(r=n.find(".notationHorizontal"),r.length&&r.each(function(e,n){$(n).find(".gotomove").each(function(e,n){var t=$(n).text().match(/\d*\.\s*(.*)/);o.push(t?t[1]:$(n).text())})}));var i,a,c=CC.classify_opening(o);i=c.moves?"Opening: "+c.moves.eco+":  "+c.moves.name+" ("+c.moves.moves+")":"N/A",a=c.fen?"Position: "+c.fen.eco+":  "+c.fen.name+" ("+c.fen.moves+")":"N/A";var u=1;return CC.analyzed_games_cache[t]&&CC.analyzed_games_cache[t].opening==i&&CC.analyzed_games_cache[t].fen==a&&(u=CC.analyzed_games_cache[t].count+1),CC.analyzed_games_cache[t]={opening:i,fen:a,count:u,num_moves:o.length},$("#ccutils_opening_moves").text()!=i&&$("#ccutils_opening_moves").text(i),$("#ccutils_opening_fen").text()!=a&&$("#ccutils_opening_fen").text(a),c},opening_refresh:function(){CC.game_all_channel=$.cometd.addListener("/game/*",function(e){CC.get_opening(e)})},flash_keyboard_icon:function(){$("#ccutils_keyboard_icon").animate({opacity:1},100).animate({opacity:.3},100)},announce_opening:function(){var e=CC.get_opening(!0);if(e){var n;n=e.moves.eco==e.fen.eco?"Opening: ("+e.moves.eco+") "+e.moves.name+" ("+(e.moves.moves.match(/\s/g).length+1)+"-ply)":similar_text(e.moves.name,e.fen.name,!0)>50?"Position: ("+e.fen.eco+") "+e.fen.name+" ("+(e.fen.moves.match(/\s/g).length+1)+"-ply)":"Position: ("+e.fen.eco+") "+e.fen.name+" ("+(e.fen.moves.match(/\s/g).length+1)+"-ply), transposed from Opening: ("+e.moves.eco+") "+e.moves.name,$(".chatInputGameWrapper input[id^=chatInput_]:visible").first().val(n),$(".chatInputGameWrapper button[id^=chatInputButton_]").click(),CC.flash_keyboard_icon(),CC.last_chat=Math.round((new Date).getTime()/1e3)+5}}}),CC.opening_checker=setInterval(CC.get_opening,5e3),CC.analyzed_games_cache={},setInterval(function(){CC.analyzed_games_cache={}},3e5),CC.opening_refresh();var e=$("<div/>").attr("id","ccutils_wrapper").css({position:"fixed",top:35,"z-index":9,color:"white",height:"28px",width:"100%"}).appendTo(body),n=$("<div/>").attr("id","ccutils_opening").css({"background-color":"#6a943f",margin:"0px 5px",height:"100%","border-radius":"5px 5px 0px 0px","border-top":"1px solid #799e52","border-bottom":"1px solid #4c7637","padding-left":"5px"}).appendTo(e).click(CC.get_opening),t=($("<p/>").attr({id:"ccutils_opening_moves",title:"Opening classification according to the move order."}).css({"font-size":"12px","line-height":"14px"}).appendTo(n),$("<p/>").attr({id:"ccutils_opening_fen",title:"Opening classification according to the game position."}).css({"font-size":"12px","line-height":"14px"}).appendTo(n),$("<div/>").attr("id","ccutils_keyboard_icon").css({"background-image":"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACEUlEQVRYhe3WMUhVURgH8N8xEZGIBgmRiKjFJFpqiIoWy6GhNVocm4qWkJpEJGoLXJormhtU2iKCBhscKiJaopJKCbEQCTFPw/2eXV/vYQ96vOV9l8O9/+/7zjn/+53/PeemLGuldbR09jaBNoE2AXRWHpJ0CuM40MT51nAPk1legVTZiJL0GMN400QCe9CDoSy/oFQB7MUKTuJnkwhMYBS7K45aGliP1oGNLK+V8HpgkOW1wOXcjarc6tgWqyfCM/iCa4EvYwHnk9SLKcwmqTdJxyM2kaQO3Im+A5G7gIf1StJZx7+MOXwO/DXwkkJI77AYlVmJ2IfIfR94NcbfhZ31CMhx4RW+oydwR6WVcrbFVbF+ZMyE71bg4UpezQokaRBXSngmy9MYwaEk3cUP3MAnTCbpNC4k6UFU4DoO1n3zsHpLsB+X/NHIEqZxVqGPRwpBjeA1JnEk+syG7yIGov96owSeVLFfjvtVdCvWfwNHS4PfD5LfFOs/hK6IrTZKoBt9mM/yfJL6knSiFN9XTk5SeffsD3IvFYI9pqjgYs2ZaokQ5xRiGY/YaOBG2mHFzpcx1ZAIFZ/ZGJ4GfhZ4O9uBX1GBRcUnOoa39TrUItCFj7gNSepSqHruHwjUsvI4f81XdsxjEM/V2DL/k/UpqlIR9RYCNxVv38zjeElxHG+euJvHcaus5X9EbQJtAm0CvwEi8Mhr8HnPPAAAAABJRU5ErkJggg==')",position:"fixed",top:34,right:10,"z-index":9,height:32,width:32,opacity:.3}).attr("title",' Key Bindings:\n   "shift+c s" Seek Game\n   "shift+c d" Offer Draw\n   "shift+c r" Resign\n   "shift+c shift+r" Clean Refresh\n   "shift+c shift+a" Announce Opening').appendTo(body),setInterval(function(){Mousetrap&&(clearInterval(t),Mousetrap.bind("shift+c s",function(){CC.flash_keyboard_icon(),$("#new_game_pane_create_button").click()}),Mousetrap.bind("shift+c d",function(){$("input[id^=b-draw]:visible").get(0)&&(CC.flash_keyboard_icon(),$("input[id^=b-draw]:visible").click())}),Mousetrap.bind("shift+c r",function(){$("input[id^=b-resign-abort]:visible").get(0)&&(CC.flash_keyboard_icon(),$("input[id^=b-resign-abort]:visible").click())}),Mousetrap.bind("shift+c shift+r",function(){CC.flash_keyboard_icon(),$(".nowrapTabStrip .dijitTabCloseButton").click(),setTimeout(function(){window.location="http://live.chess.com/live"},350)}),Mousetrap.bind("shift+c shift+a",function(){CC.announce_opening()}))},300))}();